# Claude Code Sandbox with Metis
# Extends Docker's official Claude sandbox with Metis work management
#
# Base image includes:
# - Claude Code with automated credential handling
# - Docker CLI, GitHub CLI, Node.js, Go, Python 3, Git, ripgrep, jq
# - Runs as non-root 'agent' user with sudo access
#
# This image adds:
# - Metis CLI and MCP server
# - Metis plugin for Claude Code

FROM docker/sandbox-templates:claude-code

# Install Rust (needed to build Metis)
USER root
RUN curl --proto '=https' --tlsv1.2 -sSf https://sh.rustup.rs | sh -s -- -y
ENV PATH="/root/.cargo/bin:${PATH}"

# Install build dependencies for Metis
RUN apt-get update && apt-get install -y \
    build-essential \
    pkg-config \
    libsqlite3-dev \
    libssl-dev \
    && rm -rf /var/lib/apt/lists/*

# Clone and build Metis CLI (includes MCP server via `metis mcp` subcommand)
ARG METIS_VERSION=main
RUN git clone --depth 1 --branch ${METIS_VERSION} https://github.com/colliery-io/metis.git /tmp/metis \
    && cd /tmp/metis \
    && cargo build --release -p metis-docs-cli \
    && cp target/release/metis /usr/local/bin/metis \
    && chmod +x /usr/local/bin/metis \
    && rm -rf /tmp/metis /root/.cargo/registry /root/.cargo/git

# Install Metis plugin for the agent user
USER agent

# Clone Metis repo to get plugin files (uses same version as CLI build)
ARG PLUGIN_VERSION=main
RUN mkdir -p /home/agent/.claude/plugins/marketplaces/colliery-io-metis/plugins \
    && git clone --depth 1 --branch ${PLUGIN_VERSION} https://github.com/colliery-io/metis.git /tmp/metis-plugin \
    && cp -r /tmp/metis-plugin/plugins/metis /home/agent/.claude/plugins/marketplaces/colliery-io-metis/plugins/ \
    && rm -rf /tmp/metis-plugin

# Configure MCP server for Metis
RUN mkdir -p /home/agent/.claude && \
    echo '{"mcpServers":{"metis":{"command":"metis","args":["mcp","--project-path","/workspace"]}}}' > /home/agent/.mcp.json

# Back to agent user for runtime
WORKDIR /workspace
CMD ["claude"]
